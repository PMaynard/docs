---
id: mfa
title: Multi-factor authentication
sidebar_label: Multi-factor authentication
---

## Use case: Use multi-factor authentication to protect user accounts

## Multi-factor authentication methods

### Time-based one time Passwords

Time-based one time passwords (TOTP) is a flexible 2FA authentication method based on a shared secret, and can be used both with
browser-based apps and with native apps. To use TOTP, a user needs to install a TOTP authenticator app, such as
[Google Authenticator](https://g.co/kgs/YgRFR5) or [FreeOTP](https://freeotp.github.io/), on their mobile phone.

A user's experience of working with TOTP is illustrated in the following figure:

TBD - ADD DIAGRAM SHOWING USER ACTIONS

1. When a user first signs up for TOTP-based 2FA authentication, they pair the TOTP app with their account in Ory Network. During
   the TOTP sign-up flow, the user is prompted to scan a QR code into the TOTP app on their mobile phone. This step effectively
   transfers the shared secret to the TOTP app.
2. Subsequently, whenever the user is prompted to authenticate using the TOTP second factor, the user proceeds as follows. The
   user opens the TOTP app on their phone, selects the relevant account in the app, and enters the short code (typically a
   six-digit code) to authenticate the second factor.

The short code from the TOTP app is generated by combining the shared secret with the current date and time. The code is valid
only for a short time (usually 30 seconds or less). This is how the _time-based one time passwords_ method gets its name.

### W3C Web Authentication (WebAuthn)

WebAuthn is a 2FA authentication method based on symmetric key algorithms, which can be used **only** with browser-based apps. The
WebAuthn part of the standard (developed in collaboration between the FIDO alliance and the W3C consortium) works only in a
browser, which is why it is a browser-only authentication method.

The WebAuthn 2FA authentication method is a flexible mechanism that delegates authentication to the underlying platform. There are
many different ways a user can verify their identity, including biometric authentication devices and external hardware.

There are two main categories of authenticators you can use with WebAuthn:

- **On-device authenticators** which includes platform-based biometric authentication protocols, such as TouchID, FaceID, Windows
  Hello, or Android Biometric Authentication
- **External authenticators** which includes NFC devices, USB keys, or Bluetooth Low Energy (BLE) devices, for example a
  [YubiKey](https://www.yubico.com/why-yubico/how-the-yubikey-works/).

In practice, the user experience of working with WebAuthn is simple. Whenever the user is expected to authenticate using the
WebAuthn second factor, the web browser displays a special prompt. For example, Google Chrome shows a prompt like the following:

TBD - SCREENSHOT OF PROMPT FROM GOOGLE CHROME

What the user does next depends on their chosen verification method. For example, if the user chooses to use fingerprint
verification, the user touches the fingerprint sensor and the authentication process completes automatically.

In spite of its apparent simplicity, the WebAuthn authentication protocol is very secure, because it leverages symmetric key
technology. For more details, see [PassKeys and passwordless sign-in](passwordless.md).

## Ory MFA in practice

When it comes to using MFA in practice, there are a variety of strategies you can use for authentication with the second factor.
For example, you might decide to require a user to log in with two factors right at the start of the session. Alternatively, you
could allow the user to start the session by logging in with the first factor and only require the second factor at the point
where the user is about to perform a security-sensitive operation (step up authenticaiton).

### Supported MFA combinations

Ory Identities enables you to combine first and second factor authentication methods in a variety of ways, as shown in the
following table. The valid combinations depend on whether you are developing a browser-based app or a native app.

| First factor           | Second factor (Browser-based app)                | Second factor (Native app |
| ---------------------- | ------------------------------------------------ | ------------------------- |
| Password               | TOTP, Passkey, Biometric, External authenticator | TOTP                      |
| Social sign-in         | TOTP, Passkey, Biometric, External authenticator | TOTP                      |
| Passkey                | TOTP                                             | TOTP                      |
| Biometric              | TOTP                                             | TOTP                      |
| External authenticator | TOTP                                             | TOTP                      |

### Step-up authentication

One of the practical applications of MFA is _step-up authentication_, which involves requesting the second-factor of
authentication whenever a user is about to perform a security-sensitive operation.

For example, consider a typical online shopping application. A user who is authenticated with a single factor could be allowed to
browse the web site and add items to their shopping cart. But when it comes to checking out and paying for the items (which might
give the user access to stored credit card data), the app can request a second factor of authentication, _stepping up the level of
authentication_ before performing the security-sensitive operation.

There are two strategies you can use for deciding when to trigger step-up authentication:

- When a user is about to perform a sensitive operation, check that the second factor has been provided in this session.
- When a user is about to perform a sensitive operation, check that the second factor has been provided and _the second factor
  login was performed recently (fresh 2FA session)_.

#### Requiring a 2FA session for sensitive operations

Consider the case where a user is required to have a 2FA session before performing a security-sensitive operation, as illustrated
in the following figure:

TBD - FIRST STEP_UP AUTHN STRATEGY

```mdx-code-block
import Mermaid from "@site/src/theme/Mermaid";

<Mermaid
  chart={`flowchart LR
subgraph AAL 1
  direction TB
  A[Login] --> B{Sensitive?} --> C[2FA Authn]
end
subgraph AAL 2
  direction TB
  D[Perform sensitive action]
end
`} />
```

1. In this example, the user is only required to login with a single factor to start the session in the app. The user session
   initially has an authenticator assurance level (AAL) equal to 1.
2. At a certain point, the app detects that the user is about to perform a sensitive action (for example, paying for items in a
   shopping cart).
3. Because the current AAL of 1 is insufficient for performing a sensitive action, the app triggers step-up authentication and
   requires the user to log in with a second factor.
4. After successfully authenticating with the second factor, the user session has an AAL equal to 2 (second-factor authentication)
   and the user is allowed to perform sensitive operations.

To support this scenario, Ory Identities automatically sets the AAL to 1 or 2 in the current session, indicating whether the
session has been authenticated by one or two factors.

#### Requiring a fresh 2FA session for sensitive operations

A further refinement of the step-up authentication flow is to require, not only that the user has performed second-factor
authentication, but also that the second-factor authentication is fresh.

For example, consider the scenario where an attacker has managed to hijack a user's session. If the second-factor is required to
be fresh, it is likely that the second-factor is stale by the time the attacker hijacks the session, preventing the attacker from
executing any security-sensitive operations.

Consider the case where a user is initially required to log in with two factors, but the second factor times out before the user
attempts to perform a security-sensitive operation, as illustrated in the following figure:

TBD - SECOND STEP_UP AUTHN STRATEGY

1. In this example, the user is required to login with _two factors_ to start the session in the app. The user session initially
   has an authenticator assurance level (AAL) equal to 2.
2. After a certain period of time, defined by the app, the second factor times out and is treated as stale.
3. At a certain later time, the app detects that the user is about to perform a sensitive action (for example, paying for the
   items in the shopping cart).
4. Because the second factor for this session has timed out, the app triggers step-up authentication and requires the user to log
   in with a second factor.
5. After successfully authenticating with the second factor, the second factor is no longer stale and the user is allowed to
   perform sensitive operations.

To support this scenario, Ory Identities provides a time stamp for every authentication performed during the session. This enables
the app to implement the logic for checking whether the second-factor authentications are stale or not.

### Recovery Codes

Although MFA greatly improves user account security, it also slightly increases the risk of a user getting locked out of their
account. For example, a user might lose access to their selected MFA method. In this case, the familiar password recovery flow
cannot be used to regain access, because this flow does not deal with the second authentication factor.

To provide users with a way of recovering access to their account after losing the second factor, a system administrator can
enable Recovery Codes (also known as Backup Codes or Lookup Secrets) in the Ory Console. After enabling **Lookup Secrets** in the
Ory Console, users will see a new section, **2FA Backup Codes**, in their account settings self-service flow. By clicking the
**Generate new backup recovery codes** button, a user can generate a set of recovery codes, which appears as follows in the Ory
Account Experience UI:

![Recovery Codes in Ory Account Experience](_static/mfa-recovery-codes.png)

If the user loses access to the second factor at a later time, they are presented with the option of entering a recovery code to
regain access to their account (where the recovery codes must be used in sequence and each code is valid for single use only).

You could also customize the user experience in your app to prompt a user to create the recovery codes immediately after they
register their second factor.

For more details about using recovery codes in Ory Network, see
[Lookup Secrets - a MFA fail-safe](https://www.ory.sh/docs/kratos/mfa/lookup-secrets).
